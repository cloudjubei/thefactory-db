version: '3.8'

services:
  db:
    image: pgvector/pgvector:pg16
    container_name: thefactory-db-postgres
    environment:
      POSTGRES_DB: thefactory-db
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
    ports:
      # Expose on 55432 to avoid clashing with any local Postgres on 5432
      - '55432:5432'
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U user']
      interval: 5s
      timeout: 5s
      retries: 10
    restart: unless-stopped

  # One-off bootstrap job that ensures the database exists and vector extension is available.
  # This runs against an already-initialized cluster and is safe to re-run.
  db-init:
    image: pgvector/pgvector:pg16
    depends_on:
      db:
        condition: service_healthy
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      PGPASSWORD: password
    entrypoint: ['/bin/bash', '-c']
    command: |
      set -e
      until pg_isready -h db -p 5432 -U "$POSTGRES_USER"; do
        echo "[db-init] waiting for db..."
        sleep 1
      done
      echo "[db-init] ensuring database exists..."
      psql -h db -U "$POSTGRES_USER" -d postgres -tc "SELECT 1 FROM pg_database WHERE datname = 'thefactory-db'" | grep -q 1 || \
        psql -h db -U "$POSTGRES_USER" -d postgres -c 'CREATE DATABASE "thefactory-db"'
      echo "[db-init] ensuring vector extension..."
      psql -h db -U "$POSTGRES_USER" -d "thefactory-db" -c 'CREATE EXTENSION IF NOT EXISTS vector'
    restart: 'no'

volumes:
  postgres_data:
